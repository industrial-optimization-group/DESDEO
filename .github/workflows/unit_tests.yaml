name: "Unit tests"

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install Python 3.12
        run: uv python install 3.12

      - name: Install DESDEO (all extras)
        run: uv sync --all-extras --python 3.12

      - name: Create needed folders for solver binaries
        run: mkdir -p "$HOME/tmp/custom_binaries"

      - name: Download custom binaries
        run: wget https://github.com/industrial-optimization-group/DESDEO/releases/download/supplementary/solver_binaries.tgz -O $HOME/tmp/binaries.tgz

      - name: Extract custom binaries
        run: tar --strip-components=1 -xzf "$HOME/tmp/binaries.tgz" -C "$HOME/tmp/custom_binaries"

      - name: Make binaries executable
        run: chmod +x "$HOME/tmp/custom_binaries"/*

      - name: Add binaries to path
        run: echo "$HOME/tmp/custom_binaries" >> "$GITHUB_PATH"

      - name: Check path
        run: echo $PATH

      - name: Check that binaries are available
        run: |
          command -v ipopt
          command -v bonmin

      - name: Check Python and Pytest paths
        run: |
          uv run python -V
          uv run pytest -m "not nautilus and not performance and not skip" --collect-only

      - name: Run unit tests
        run: |
          uv run pytest -n auto -m "not nautilus and not performance and not skip" --disable-warnings --maxfail=5
